# kernel/core.py
# ==========================================
# N√∫cleo principal do InfiniteOS
# ==========================================
import math
import random
from time import time
from kernel.scheduler import HarmonicScheduler
from kernel.semantic import SemanticLayer

class InfiniteKernel:
    def __init__(self):
            self.semantic = SemanticLayer()
                    self.layers = []

                        def evolve(self, data):
                                # processa o dado no n√≠vel harm√¥nico
                                        harmonic = [d * 1.618 for d in data]
                                                meaning = self.semantic.interpret(harmonic)
                                                        self.layers.append(meaning)
                                                                return meaning

PHI = (1 + math.sqrt(5)) / 2


class InfiniteKernel:
    """
        N√∫cleo harm√¥nico evolutivo do InfiniteOS.
            Respons√°vel por coordenar camadas, processos e o ciclo de evolu√ß√£o do sistema.
                """

                    def __init__(self, mode="1 6 1 8"):
                            self.mode = mode
                                    self.state = {
                                                "boot_time": time(),
                                                            "layers": [],
                                                                        "phi": PHI,
                                                                                    "entropy": 0.0
                                                                                            }
                                                                                                    # Inicializa o scheduler harm√¥nico
                                                                                                            self.scheduler = HarmonicScheduler(tick=0.05)
                                                                                                                    print(f"‚öôÔ∏è  Kernel initialized in œÜ-mode: {self.mode}")

                                                                                                                            # Registra processos internos
                                                                                                                                    self._register_internal_tasks()

                                                                                                                                        # ---------------------------------------------
                                                                                                                                            # Evolu√ß√£o e camadas
                                                                                                                                                # ---------------------------------------------
                                                                                                                                                    def evolve(self):
                                                                                                                                                            """
                                                                                                                                                                    Simula a evolu√ß√£o de uma camada do kernel,
                                                                                                                                                                            retornando metadados da nova camada harm√¥nica.
                                                                                                                                                                                    """
                                                                                                                                                                                            t = len(self.state["layers"]) + 1
                                                                                                                                                                                                    entropy_delta = math.sin(t / PHI) * random.random()
                                                                                                                                                                                                            new_entropy = self.state["entropy"] + entropy_delta

                                                                                                                                                                                                                    layer = {
                                                                                                                                                                                                                                "index": t,
                                                                                                                                                                                                                                            "timestamp": time(),
                                                                                                                                                                                                                                                        "entropy_delta": entropy_delta,
                                                                                                                                                                                                                                                                    "description": f"Harmonic Layer {t} stabilized (ŒîS={entropy_delta:.5f})"
                                                                                                                                                                                                                                                                            }
                                                                                                                                                                                                                                                                                    self.state["entropy"] = new_entropy
                                                                                                                                                                                                                                                                                            self.state["layers"].append(layer)
                                                                                                                                                                                                                                                                                                    return layer

                                                                                                                                                                                                                                                                                                        # ---------------------------------------------
                                                                                                                                                                                                                                                                                                            # Integra√ß√£o com scheduler harm√¥nico
                                                                                                                                                                                                                                                                                                                # ---------------------------------------------
                                                                                                                                                                                                                                                                                                                    def _register_internal_tasks(self):
                                                                                                                                                                                                                                                                                                                            """
                                                                                                                                                                                                                                                                                                                                    Registra processos internos autom√°ticos do kernel:
                                                                                                                                                                                                                                                                                                                                            - harmonic_maintenance: mant√©m sincroniza√ß√£o œÜ.
                                                                                                                                                                                                                                                                                                                                                    - entropy_logger: registra varia√ß√µes harm√¥nicas.
                                                                                                                                                                                                                                                                                                                                                            """

                                                                                                                                                                                                                                                                                                                                                                    def harmonic_maintenance(ctx):
                                                                                                                                                                                                                                                                                                                                                                                while True:
                                                                                                                                                                                                                                                                                                                                                                                                # Ajusta pequenas varia√ß√µes entr√≥picas
                                                                                                                                                                                                                                                                                                                                                                                                                self.state["entropy"] *= 0.999 + random.random() * 0.0002
                                                                                                                                                                                                                                                                                                                                                                                                                                print(f"[{ctx['name']}] œÜ-maintenance cycle")
                                                                                                                                                                                                                                                                                                                                                                                                                                                yield

                                                                                                                                                                                                                                                                                                                                                                                                                                                        def entropy_logger(ctx):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                    while True:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    e = self.state["entropy"]
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    print(f"[{ctx['name']}] entropy={e:.6f}")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    yield

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            # Registra tarefas no scheduler harm√¥nico
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    self.scheduler.spawn(harmonic_maintenance, name="œÜ-maintenance", priority=3)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            self.scheduler.spawn(entropy_logger, name="entropy-logger", priority=1)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                # ---------------------------------------------
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    # Execu√ß√£o principal do kernel
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        # ---------------------------------------------
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            def run(self, runtime=5.0):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    """
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            Executa o ciclo harm√¥nico do kernel por tempo determinado.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    """
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            print("üß† Kernel harmonic cycle started...")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    self.scheduler.run(runtime=runtime)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            print("üß© Kernel harmonic cycle finished.")


                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            # ==========================================
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            # Execu√ß√£o isolada para teste r√°pido
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            # ==========================================
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            if __name__ == "__main__":
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                kernel = InfiniteKernel()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    for _ in range(3):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            layer = kernel.evolve()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    print("Layer:", layer["description"])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        kernel.run(runtime=2.0)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            print("Kernel state:", kernel.state)